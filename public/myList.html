<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Good Games</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">

        <!-- Title -->
        <p class="title">
            <span class="bigLetter">G</span>ood
            <span class="bigLetter">G</span>ame
            <span class="bigLetter">S</span>
        </p>

        <!-- Auth Buttons -->

        <div class="sideMenu" id="sideMenu">
            <div class="hamburger" id="hamburger">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="sideMenuPanel" id="sideMenuPanel">
                <div class="hamburger" id="sideMenuHamburger">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="sideMenuItems">
                    <div class="sideMenuItem">
                        <a href="Home.html" class="menuItem" id="homeLink">Home</a>
                    </div>
                    <div class="sideMenuItem" id="myListItem" style="display: none;">
                        <a href="myList.html" class="menuItem" id="myListLink">My List</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="search.html" class="menuItem" id="myListLink">Search</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="myList.html" class="menuItem" id="myListLink">Placeholder</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="about.html" class="menuItem" id="aboutLink">About</a>
                    </div>
                </div>
            </div>

        </div>


        <div class="myListContainer" id="myListContainer">
            <h2 class="listTitle" id="listTitle">My Games List</h2>
            <table id="myTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Platforms</th>
                        <th>Release Year</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody id="tableBody">

                </tbody>
            </table>
        </div>
    </div>
</body>
<style>
    img {
        max-width: 100px;
        border-radius: 8px;
    }
</style>

<script>

    async function getMyList() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('You must be logged in to view your list.');
            return;
        }

        try {
            const res = await fetch('/myList', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': `Bearer ${token}`
                }
            });

            const result = await res.json();
            const tableBody = document.getElementById('tableBody');

            if (res.ok) {
                // Clear previous rows
                tableBody.innerHTML = '';

                result.forEach(game => {
                    const row = document.createElement('tr');

                    // Image cell
                    const imgCell = document.createElement('td');
                    if (game.image) {
                        const img = document.createElement('img');
                        img.src = game.image;
                        img.alt = game.game_name || 'Game Image';
                        imgCell.appendChild(img);
                    } else {
                        imgCell.textContent = 'No Image';
                    }
                    row.appendChild(imgCell);

                    // Title
                    const titleCell = document.createElement('td');
                    titleCell.textContent = game.game_name || '';
                    row.appendChild(titleCell);

                    // Genre
                    const genreCell = document.createElement('td');
                    genreCell.textContent = game.genre || '';
                    row.appendChild(genreCell);

                    // Platforms
                    const platformsCell = document.createElement('td');
                    platformsCell.textContent = game.platforms || '';
                    row.appendChild(platformsCell);

                    // Release Year
                    const releaseYearCell = document.createElement('td');
                    releaseYearCell.textContent = game.release_year || '';
                    row.appendChild(releaseYearCell);

                    // Rating
                    const ratingCell = document.createElement('td');
                    ratingCell.textContent = game.rating || '';
                    row.appendChild(ratingCell);

                    tableBody.appendChild(row);
                });
            }
            else {
                tableBody.innerHTML = 'Failed to load your list.';
            }
        }
        catch (err) {
            console.error(err);
            alert('An error occurred while fetching your list.');
        }
    }


    getMyList();

/*
Try and add pages? maybe a later thing
*/

    document.getElementById('hamburger').addEventListener('click', function () {
        const panel = document.getElementById('sideMenuPanel');
        panel.classList.toggle('open');
    });

    document.getElementById('sideMenuHamburger').addEventListener('click', function () {
        const panel = document.getElementById('sideMenuPanel');
        panel.classList.remove('open');
    });

    function isTokenValid(token) {
        if (!token) return false;

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.exp * 1000 > Date.now();
        }
        catch (e) {
            return false;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const sideMenuMyList = document.getElementById('myListItem');
        if (isTokenValid(token)) {
            sideMenuMyList.style.display = 'block';
        }
    })
</script>

</html>