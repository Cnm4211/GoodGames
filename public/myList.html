<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Good Games</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">

        <!-- Title -->
        <p class="title">
            <span class="bigLetter">G</span>ood
            <span class="bigLetter">G</span>ame
            <span class="bigLetter">S</span>
        </p>

        <!-- Auth Buttons -->
        <div class="auth-buttons">
            <a href="signIn.html"> <button class="auth-button" id="signInButton">Sign In</button> </a>
            <a href="signUp.html"> <button class="auth-button" id="signUpButton">Sign Up</button> </a>
            <a href="myList.html"> <button class="auth-button" id="myListButton" style="display:none; width: 150px; ">My
                    List
                </button> </a>
            <button class="auth-button" id="logoutButton" style="display:none;">Logout</button>
        </div>

        <div class="sideMenu" id="sideMenu">
            <div class="hamburger" id="hamburger">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="sideMenuPanel" id="sideMenuPanel">
                <div class="hamburger" id="sideMenuHamburger">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="sideMenuItems">
                    <div class="sideMenuItem">
                        <a href="Home.html" class="menuItem" id="homeLink">Home</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="search.html" class="menuItem" id="myListLink">Search</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="seachFriends.html" class="menuItem" id="friendsLink">Find Friends</a>
                    </div>
                    <div class="sideMenuItem" id="myListItem" style="display: none;">
                        <a href="myList.html" class="menuItem" id="myListLink">My List</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="profile.html" class="menuItem" id="myListLink">My Profile</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="friendsList.html" class="menuItem" id="myFriendsLink">My Friends</a>
                    </div>
                    <div class="sideMenuItem">
                        <a href="about.html" class="menuItem" id="aboutLink">About</a>
                    </div>
                </div>
            </div>

        </div>


        <div class="myListContainer" id="myListContainer">
            <h2 class="listTitle" id="listTitle">My Games List</h2>
            <div class="filterButtons">
                <select id="genre" name="genre">
                    <option value="">Genre</option>
                    <option value="Action">Action</option>
                    <option value="Indie">Indie</option>
                    <option value="Adventure">Adventure</option>
                    <option value="RPG">RPG</option>
                    <option value="Strategy">Strategy</option>
                    <option value="Shooter">Shooter</option>
                    <option value="Casual">Casual</option>
                    <option value="Simulation">Simulation</option>
                    <option value="Puzzle">Puzzle</option>
                    <option value="Arcade">Arcade</option>
                    <option value="Platformer">Platformer</option>
                    <option value="Massively Multiplayer">Massively Multiplayer</option>
                    <option value="Racing">Racing</option>
                    <option value="Sports">Sports</option>
                    <option value="Fighting">Fighting</option>
                    <option value="Family">Family</option>
                    <option value="Board Games">Board Games</option>
                    <option value="Card">Card</option>
                    <option value="Educational">Educational</option>
                </select>
                <select id="platform" name="platform">
                    <option value="">Platform</option>
                    <option value="PC">PC</option>
                    <option value="PlayStation 5">PlayStation 5</option>
                    <option value="Xbox One">Xbox One</option>
                    <option value="PlayStation 4">PlayStation 4</option>
                    <option value="Xbox Series S/X">Xbox Series S/X</option>
                    <option value="Nintendo Switch">Nintendo Switch</option>
                    <option value="iOS">iOS</option>
                    <option value="Android">Android</option>
                    <option value="Nintendo 3DS">Nintendo 3DS</option>
                    <option value="Nintendo DS">Nintendo DS</option>
                    <option value="Nintendo DSi">Nintendo DSi</option>
                    <option value="macOS">macOS</option>
                    <option value="Linux">Linux</option>
                    <option value="Xbox 360">Xbox 360</option>
                    <option value="Xbox">Xbox</option>
                    <option value="PlayStation 3">PlayStation 3</option>
                    <option value="PlayStation 2">PlayStation 2</option>
                    <option value="PlayStation">PlayStation</option>
                    <option value="PS Vita">PS Vita</option>
                    <option value="PSP">PSP</option>
                    <option value="Wii U">Wii U</option>
                    <option value="Wii">Wii</option>
                    <option value="GameCube">GameCube</option>
                    <option value="Nintendo 64">Nintendo 64</option>
                    <option value="Game Boy Advance">Game Boy Advance</option>
                    <option value="Game Boy Color">Game Boy Color</option>
                    <option value="Game Boy">Game Boy</option>
                    <option value="SNES">SNES</option>
                    <option value="NES">NES</option>
                    <option value="Classic Macintosh">Classic Macintosh</option>
                    <option value="Apple II">Apple II</option>
                    <option value="Commodore / Amiga">Commodore / Amiga</option>
                    <option value="Atari 7800">Atari 7800</option>
                    <option value="Atari 5200">Atari 5200</option>
                    <option value="Atari 2600">Atari 2600</option>
                    <option value="Atari Flashback">Atari Flashback</option>
                    <option value="Atari 8-bit">Atari 8-bit</option>
                    <option value="Atari ST">Atari ST</option>
                    <option value="Atari Lynx">Atari Lynx</option>
                    <option value="Atari XEGS">Atari XEGS</option>
                    <option value="Genesis">Genesis</option>
                    <option value="SEGA Saturn">SEGA Saturn</option>
                    <option value="SEGA CD">SEGA CD</option>
                    <option value="SEGA 32X">SEGA 32X</option>
                    <option value="SEGA Master System">SEGA Master System</option>
                    <option value="Dreamcast">Dreamcast</option>
                    <option value="3DO">3DO</option>
                    <option value="Jaguar">Jaguar</option>
                    <option value="Game Gear">Game Gear</option>
                    <option value="Neo Geo">Neo Geo</option>
                </select>
                <button class="filterButton" id="release_year">Release Year</button>
                <button class="filterButton" id="rating">Rating</button>
                <button class="filterButton" id="score">Score</button>

            </div>
            <table id="myTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Platforms</th>
                        <th>Release Year</th>
                        <th>Rating</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="tableBody">

                </tbody>
            </table>
        </div>
    </div>
</body>
<style>
    img {
        max-width: 100px;
        border-radius: 8px;
    }
</style>

<script>

    gamesList = [];
    async function getMyList() {
        const token = localStorage.getItem('token');
        const userId = new URLSearchParams(window.location.search).get("id") || JSON.parse(atob(token.split('.')[1])).userId;
        if (!token) {
            alert('You must be logged in to view your list.');
            return;
        }

        try {
            const res = await fetch(`/myList/${userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': `Bearer ${token}`
                }
            });

            const result = await res.json();
            const tableBody = document.getElementById('tableBody');

            if (res.ok) {
                gamesList = result;
                renderTable(result);
            }
            else {
                tableBody.innerHTML = 'Failed to load your list.';
            }
        }
        catch (err) {
            console.error(err);
            alert('An error occurred while fetching your list.');
        }
    }

    function renderTable(games) {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        if (!games || games.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8">Your list is empty.</td></tr>';
            return;
        }
        let number = 1;
        games.forEach((game, idx) => {
            const row = document.createElement('tr');

            const numberCell = document.createElement('td');
            numberCell.textContent = number;
            row.appendChild(numberCell);

            // Image cell
            const imgCell = document.createElement('td');
            if (game.image) {
                const img = document.createElement('img');
                img.src = game.image;
                img.alt = game.game_name || 'Game Image';
                imgCell.appendChild(img);
            } else {
                imgCell.textContent = 'No Image';
            }
            row.appendChild(imgCell);

            // Title
            const titleCell = document.createElement('td');
            titleCell.textContent = game.game_name || '';
            row.appendChild(titleCell);

            // Genre
            const genreCell = document.createElement('td');
            genreCell.textContent = game.genre || '';
            row.appendChild(genreCell);

            // Platforms
            const platformsCell = document.createElement('td');
            platformsCell.textContent = game.platforms || '';
            row.appendChild(platformsCell);

            // Release Year
            const releaseYearCell = document.createElement('td');
            releaseYearCell.textContent = game.release_year || '';
            row.appendChild(releaseYearCell);

            // Rating
            const ratingCell = document.createElement('td');
            ratingCell.textContent = game.rating || '';
            row.appendChild(ratingCell);

            //Score
            const scoreCell = document.createElement('td');
            const scoreValue = game.score || "-";
            scoreCell.innerHTML = `
                <span class="score-clickable" style="cursor:pointer; color:cyan;" data-idx="${idx}">${scoreValue}</span>
                <select class="score-dropdown" style="display:none; margin-left:5px;">
                    <option value="">-</option>
                    ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                </select>
            `;
            row.appendChild(scoreCell);


            tableBody.appendChild(row);
            number++;
        });

        document.querySelectorAll('.score-clickable').forEach(span => {
            span.addEventListener('click', function () {
                const parentTd = this.parentElement;
                const dropdown = parentTd.querySelector('.score-dropdown');
                dropdown.style.display = 'inline-block';
                dropdown.focus();
            });
        });

        // Add change event listeners to all dropdowns
        document.querySelectorAll('.score-dropdown').forEach(dropdown => {
            dropdown.addEventListener('change', async function () {
                const parentTd = this.parentElement;
                const span = parentTd.querySelector('.score-clickable');
                span.textContent = this.value || "-";
                this.style.display = 'none';

                // Get the row index and game id
                const idx = span.getAttribute('data-idx');
                const game = gamesList[idx];
                const token = localStorage.getItem('token');

                try {
                    const res = await fetch('/myList/updateScore', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            id: game.id, // assuming your game object has an 'id' field
                            score: this.value ? parseInt(this.value) : null
                        })
                    });
                    const result = await res.json();
                    if (!res.ok) {
                        alert(result.message || 'Failed to update score.');
                    }
                }
                catch (err) {
                    console.error(err);
                    alert('An error occurred while updating the score.');
                }
            });
            dropdown.addEventListener('blur', function () {
                setTimeout(() => { this.style.display = 'none'; }, 200);
            });
        });
    }



    document.addEventListener('DOMContentLoaded', (event) => {
        getMyList();
    });


    //add the reverse of this, probably boolean for asc/desc
    document.getElementById('release_year').addEventListener('click', () => {
        console.log('Sorting by release year');
        gamesList.sort((a, b) => b.release_year - a.release_year);
        renderTable(gamesList);
    });

    //same here, boolean for asc/desc
    document.getElementById('rating').addEventListener('click', () => {
        console.log('Sorting by rating');
        gamesList.sort((a, b) => b.rating - a.rating);
        renderTable(gamesList);
    });

    document.getElementById('genre').addEventListener('change', (event) => {
        const genre = event.target.value;
        console.log('Filtering by genre:', genre);
        const filteredGames = genre ? gamesList.filter(game => game.genre.includes(genre)) : gamesList;
        renderTable(filteredGames);
    });

    document.getElementById('platform').addEventListener('change', (event) => {
        const platform = event.target.value;
        console.log('Filtering by platform:', platform);
        const filteredGames = platform ? gamesList.filter(game => game.platforms && game.platforms.includes(platform)) : gamesList;
        renderTable(filteredGames);
    });

    document.getElementById('score').addEventListener('click', () => {
        console.log('Sorting by score');
        gamesList.sort((a, b) => b.score - a.score);
        renderTable(gamesList);
    });

    document.getElementById('hamburger').addEventListener('click', function () {
        const panel = document.getElementById('sideMenuPanel');
        panel.classList.toggle('open');
    });

    document.getElementById('sideMenuHamburger').addEventListener('click', function () {
        const panel = document.getElementById('sideMenuPanel');
        panel.classList.remove('open');
    });

    function isTokenValid(token) {
        if (!token) return false;

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.exp * 1000 > Date.now();
        }
        catch (e) {
            return false;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const sideMenuMyList = document.getElementById('myListItem');
        if (isTokenValid(token)) {
            sideMenuMyList.style.display = 'block';
        }
    })

    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const myListButton = document.getElementById('myListButton');
        const signInButton = document.getElementById('signInButton');
        const signUpButton = document.getElementById('signUpButton');
        const sideMenuMyList = document.getElementById('myListItem');
        const logoutButton = document.getElementById('logoutButton');
        if (isTokenValid(token)) {
            myListButton.style.display = 'block';
            signInButton.style.display = 'none';
            signUpButton.style.display = 'none';
            sideMenuMyList.style.display = 'block';
            logoutButton.style.display = 'block';
        }
        else {
            myListButton.style.display = 'none';
            signInButton.style.display = 'block';
            signUpButton.style.display = 'block';
            logoutButton.style.display = 'none';
        }
    })
</script>

</html>